"use strict";
// var re_dayurl=new RegExp('day\/\\d{8}\/');
var re_dayurl=new RegExp('\\d{8}\/');
var re_monthurl=new RegExp('month\/\\d{6}\/');
var re_yearurl=new RegExp('year\/\\d{4}\/');

function findDateFormat(){
    var url=window.location.href;
    if(re_dayurl.test(url)){return'day';}
    if(re_monthurl.test(url)){return'month';}
    if(re_yearurl.test(url)){return'year';}
    return undefined;}

function getPageDate(){
    var dateformat=findDateFormat();

    if(dateformat=='day'){
        var datestring=String(re_dayurl.exec(window.location.href)).split('/')[1];
        return moment(datestring,'YYYYMMDD');}

    if(dateformat=='month'){
        var datestring=String(re_monthurl.exec(window.location.href)).split('e')[1];
        return moment(datestring,'YYYYMM');}

    if(dateformat=='year'){
        var datestring=String(re_yearurl.exec(window.location.href)).split('/')[1];
        return moment(datestring,'YYYY');}

    throw"Cannot parse date format '"+dateformat+"'";}

function stepDate(step){
    var dateformat=findDateFormat();
    var date=getPageDate();
    var newdate=date.add(dateformat,step);

    if(!dateformat){return;}

    if(dateformat=='day'){
        move_to_date({type:'changeDate',date:newdate});}

    else if(dateformat=='month'){
        move_to_date({type:'changeMonth',date:newdate});}

    else if(dateformat=='year'){
        move_to_date({type:'changeYear',date:newdate});}}

$.fn.load_state=function loadState(page){
    if($(this).attr('id')==undefined){return;}

    $('#main').load(page);$(this).set_state();}

$.fn.set_state=function setState(){
    if($(this).attr('id')==undefined){return;}

    var id=$(this).attr('id').substring(6);$('#states').html($(this).attr('title')+' <b class="caret"></b>');$('.state').removeClass('open');$(this).toggleClass('open');window.location.hash='#'+id;$('a.ifo-switch').each(function(){var oldurl=$(this).attr('href');
    var oldhash=oldurl.split('#')[1];$(this).attr('href',oldurl.replace(oldhash,id));});}

function move_to_date(ev){
    var url=window.location.href;
    var date=moment(ev.date);

    if(ev.type=='changeDate'){
        var newformat= date.format('YYYYMMDD')+'/';
        var dispdate=date.format('MMMM Do YYYY');}

    else if(ev.type=='changeMonth'){
        var newformat='month/'+date.format('YYYYMM')+'/';
        var dispdate=date.format('MMMM YYYY');}

    else if(ev.type=='changeYear'){
        var newformat='year/'+date.format('YYYY')+'/';
        var dispdate=date.format('YYYY');}

    if(re_dayurl.test(url)){
        var newurl=url.replace(re_dayurl,newformat);}

    else if(re_monthurl.test(url)){
        var newurl=url.replace(re_dayurl,newformat);}

    else if(re_yearurl.test(url)){
        var newurl=url.replace(re_dayurl,newformat);}

    else if(window.location.href==document.getElementsByTagName('base')[0].href){var newurl=window.location.href+newformat;}

    else{alert("ERROR: Cannot format new date. If the problem persists, please report this at https://github.com/gwpy/gwsumm/issues/");}

    window.location=newurl;}

function reset_width_on_resize(){
    $('#nav').width($("#nav").width());}

function resizeFancyboxIframe(){
    var width=Math.min(1200,$(".fancybox-skin").width());
    var height=(width-40)*0.5;if(width>document.body.clientWidth){$(".fancybox-iframe").width(width-40);}
    else{$(".fancybox-iframe").width(width);}
    $(".fancybox-wrap").width(width+30);$(".fancybox-iframe").height(parseInt($(".fancybox-iframe").width()*0.5));$(".fancybox-wrap").height(parseInt($(".fancybox-wrap").width()*0.5));}

function shortenDate(){
    var $calendar=$('#calendar');
    var date_=moment($calendar.data('date'),$calendar.data('date-format').toUpperCase());
    if($calendar.html().startsWith('Calendar')){return;}
    if($(document).width()<400){$calendar.html(date_.format('MMM D YYYY'));}
    else{$calendar.html(' '+date_.format('MMMM D YYYY')+' <b class="caret"></b>');}}

$(window).load(function(){
    if($('#calendar').length){shortenDate();}
    var thisbase=document.getElementsByTagName('base')[0].href;$('[data-new-base]').each(function(){var newbase=$(this).data('new-base')+'/';$(this).attr('href',window.location.href.replace(thisbase,newbase));});$('#calendar').datepicker({weekStart:1,endDate:moment().utc().format('DD/MM/YYYY'),todayHighlight:true,todayBtn:"linked"}).on('changeDate',move_to_date);if(location.hash.length>1){var hash=location.hash.substring(1);var path=location.pathname+hash+'.html';$('#state_'+hash).load_state(path);}
$(".fancybox").fancybox({nextEffect:'none',prevEffect:'none',width:1200,iframe:{scrolling:'no'},scrolling:'no',beforeShow:function(){resizeFancyboxIframe()},helpers:{overlay:{locked:false},title:{type:'inside'}}});$(".fancybox-stamp").fancybox({width:1000,height:500,showNavArrows:false,padding:0,title:this.title,href:$(this).attr('href'),type:'iframe'});$('.dropdown-toggle').on('click',function(){if($(document).width()<992){return;}
var target=$(this).nextAll('.dropdown-menu');var dropleft=$(this).offset().left;var dropwidth=target.width();var left=$(window).width();var offright=(dropleft+dropwidth>left);if(offright){target.addClass('pull-right');}});});$(window).resize(function(){if($('#calendar').length){shortenDate();}});
